// @ts-check
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { dirname } from 'path';

/**
 * Manual Pre-rendering Script for VernisAI Website
 *
 * This script pre-renders all static HTML files for all routes in the sitemap,
 * without depending on the routes.js file generated by the build process.
 *
 * Run this script after the build process:
 * npm run build
 * node scripts/pre-render-manual.js
 */

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Path to the dist directory
const distDir = path.resolve(__dirname, '../dist');

// Define action categories for the dynamic routes
// IMPORTANT: Keep this list in sync with actionCategoryIds in generate-sitemap.js
const actionCategoryIds = [
    'file-operations',
    'development-tools',
    'web-search',
    'communication',
    'smart-home',
    'ai-data',
    'marketing-social-media',
    'ecommerce',
    'task-project-management',
    'analytics-reporting',
    'notifications-alerts',
    'content-documentation',
];

// Define use case IDs for the dynamic routes
// IMPORTANT: Keep this list in sync with useCaseIds in generate-sitemap.js
const useCaseIds = [
    'content-creation',
    'data-analysis',
    'social-media-management',
    'knowledge-management',
    'learning-acceleration',
    'personal-assistant',
    'project-management',
    'email-management',
    'customer-support',
    'schedule-management',
];

// Base static routes
const staticRoutes = [
    '/',
    '/features',
    '/features/actions',
    '/features/workflows',
    '/features/agents',
    '/features/knowledge-base',
    '/use-cases',
    '/waitlist',
    '/pricing',
    '/privacy',
    '/terms',
    '/cookies',
];

// Generate dynamic routes based on action categories and use cases
function generateDynamicRoutes() {
    const dynamicRoutes = [];

    // Add action category routes
    actionCategoryIds.forEach((categoryId) => {
        dynamicRoutes.push(`/features/actions/${categoryId}`);
    });

    // Add use case routes
    useCaseIds.forEach((useCaseId) => {
        dynamicRoutes.push(`/use-cases/${useCaseId}`);
    });

    return dynamicRoutes;
}

// Combine all routes to pre-render
const allRoutes = [...staticRoutes, ...generateDynamicRoutes()];

/**
 * Pre-renders static HTML files for all routes
 */
async function preRenderRoutes() {
    console.warn('Starting manual pre-rendering process...');

    try {
        console.warn(
            `Pre-rendering ${allRoutes.length} routes (${staticRoutes.length} static, ${allRoutes.length - staticRoutes.length} dynamic)`,
        );

        // Check if dist directory exists
        if (!fs.existsSync(distDir)) {
            console.error(`Dist directory not found: ${distDir}`);
            console.error('Make sure to run the build before pre-rendering.');
            process.exit(1);
        }

        // Read the index.html template
        const indexHtmlPath = path.join(distDir, 'index.html');
        if (!fs.existsSync(indexHtmlPath)) {
            console.error(`index.html not found: ${indexHtmlPath}`);
            console.error('Make sure to run the build before pre-rendering.');
            process.exit(1);
        }

        const indexHtml = fs.readFileSync(indexHtmlPath, 'utf-8');

        // Create directories and HTML files for each route
        for (const route of allRoutes) {
            try {
                // Skip the root route as it's already handled by index.html
                if (route === '/') {
                    console.warn('Skipping root route (/)');
                    continue;
                }

                // Create the directory structure
                const routePath = route.endsWith('/')
                    ? route.slice(0, -1)
                    : route;
                const dirPath = path.join(distDir, routePath.slice(1));

                if (!fs.existsSync(dirPath)) {
                    fs.mkdirSync(dirPath, { recursive: true });
                }

                // Write the HTML file
                const htmlFilePath = path.join(dirPath, 'index.html');
                fs.writeFileSync(htmlFilePath, indexHtml);

                console.warn(`Pre-rendered: ${route} -> ${htmlFilePath}`);
            } catch (error) {
                console.error(`Error pre-rendering route ${route}:`, error);
            }
        }

        console.warn('Pre-rendering completed successfully!');
    } catch (error) {
        console.error('Error during pre-rendering:', error);
        process.exit(1);
    }
}

// Run the pre-rendering process
preRenderRoutes().catch((error) => {
    console.error('Pre-rendering failed:', error);
    process.exit(1);
});
